<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
</head>

<body>
    <script type="module">
        import { fetchRetry, mergeStream } from "./index.js"

        window.test = {
            fetchRetry: (url) => {
                let reiceive = 0
                const blackHole = new WritableStream({
                    write(chunk) {
                        // do nothing
                        reiceive += chunk.length
                        console.log(reiceive)
                    }
                })
                fetchRetry(url, { mode: "cors" }).pipeTo(blackHole)
            },
            mergeStream: (number = 10) => {
                const gens = []
                for (let i = 0; i < number; i++) {
                    gens.push(() => new Promise((resolve) => {
                        setTimeout(() => {
                            resolve(new ReadableStream({
                                async start(controller) {
                                    let j = 0
                                    while (j < number) {
                                        await new Promise((resolve) => {
                                            setTimeout(() => {
                                                resolve(controller.enqueue(j + i * number))
                                            }, 500 * Math.random());
                                        })
                                        j++
                                    }
                                    controller.close();
                                }
                            }))
                        }, 1000 * Math.random())
                    }))
                }
                const blackHole = new WritableStream({
                    write(chunk) {
                        // do nothing
                        console.log(chunk)
                    }
                })
                mergeStream(4, gens).pipeTo(blackHole)
            }
        }
    </script>
</body>

</html>