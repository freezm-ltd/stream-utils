<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
</head>

<body>
    <script type="module">
        import { retryableFetchStream, mergeStream } from "./index.js"

        window.test = {
            fetchRetry: async (url) => {
                let receive = 0
                const counter = new TransformStream({
                    transform(chunk, controller) {
                        receive += chunk.length
                        controller.enqueue(chunk)
                    }
                })
                const stream = retryableFetchStream(url, { mode: "cors" }, { minSpeed: Number.POSITIVE_INFINITY, minDuration: 5000, slowDown: 1000 }).pipeThrough(counter)
                const buffer = await (new Response(stream)).arrayBuffer()
                const hash = Array.from(new Uint8Array(await crypto.subtle.digest("SHA-1", buffer)))
                    .map((b) => b.toString(16).padStart(2, "0"))
                    .join(""); // convert bytes to hex string
                console.log("received:", receive, buffer.byteLength, ", hash:", hash)
                buffer.transfer(0) // GC
            },
            mergeStream: (number = 10) => {
                const gens = []
                for (let i = 0; i < number; i++) {
                    gens.push(() => new Promise((resolve) => {
                        setTimeout(() => {
                            resolve(new ReadableStream({
                                async start(controller) {
                                    let j = 0
                                    while (j < number) {
                                        await new Promise((resolve) => {
                                            setTimeout(() => {
                                                resolve(controller.enqueue(j + i * number))
                                            }, 500 * Math.random());
                                        })
                                        j++
                                    }
                                    controller.close();
                                }
                            }))
                        }, 1000 * Math.random())
                    }))
                }
                const blackHole = new WritableStream({
                    write(chunk) {
                        // do nothing
                        console.log(chunk)
                    }
                })
                mergeStream(4, gens).pipeTo(blackHole)
            }
        }
    </script>
</body>

</html>